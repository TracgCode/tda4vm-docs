

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>8.4. FAQ - C7x : Steps to switch C7x SysBIOS application from secure mode to non-secure mode &mdash; Platform Development Kit (PDK) - JACINTO User Guide</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="Platform Development Kit (PDK) - JACINTO User Guide" href="../index.html"/>
        <link rel="up" title="8. Frequently Asked Questions" href="../family_cfg/jacinto/index_faq_jacinto.html"/>
        <link rel="next" title="8.5. FAQ - Used Resources - Interrupt" href="resource_int_jacinto.html"/>
        <link rel="prev" title="8.3. FAQ - FVID2" href="faq_fvid2.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">
  <header id="tiHeader">
    <div class="top">
      <ul>
        <li id="top_logo">
          <a href="http://www.ti.com">
            <img src="../_static/img/ti_logo.png"/>
          </a>
        </li>
      </ul>
    </div>
    <div class="nav"></div>
  </header>
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index_jacinto.html" class="icon icon-home"> Platform Development Kit (PDK) - JACINTO User Guide
          

          
          </a>

          
            
            
              <div class="version">
                09_00_01
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <p><span class="caption-text">Table of Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../overview.html">1. Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../family_cfg/jacinto/index_release_notes_jacinto.html">2. Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started.html">3. Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../family_cfg/jacinto/index_modules_jacinto.html">4. Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../family_cfg/jacinto/index_boot_jacinto.html">5. Bootloader (SBL)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../family_cfg/jacinto/index_board_jacinto.html">6. Board/EVM Abstraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../family_cfg/jacinto/index_howto_jacinto.html">7. How to Guides</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../family_cfg/jacinto/index_faq_jacinto.html">8. Frequently Asked Questions</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="faq_common.html">8.1. FAQ - Common</a></li>
<li class="toctree-l2"><a class="reference internal" href="faq_can.html">8.2. FAQ - CAN</a></li>
<li class="toctree-l2"><a class="reference internal" href="faq_fvid2.html">8.3. FAQ - FVID2</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">8.4. FAQ - C7x : Steps to switch C7x SysBIOS application from secure mode to non-secure mode</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#introduction">8.4.1. Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-1-sysbios-config-file-changes-to-enable-boot-to-non-secure">8.4.2. Step 1: SysBIOS config file changes to enable boot to non-secure</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-2-linker-command-file-changes">8.4.3. Step 2: Linker command file changes</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-3-mmu-initialization-to-setup-secure-and-non-secure-mmu-tables">8.4.4. Step 3: MMU initialization to setup secure and non-secure MMU tables</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-4-clec-initialization-to-allow-non-secure-mode-access">8.4.5. Step 4: CLEC initialization to allow non-secure mode access</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-5-cache-initialization-to-partition-l1-l2-as-cache-vs-ram">8.4.6. Step 5: Cache initialization to partition L1/L2 as cache vs RAM</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-6-sciclient-init-to-use-non-secure-mode">8.4.7. Step 6: Sciclient init to use non-secure mode</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-7-build-and-run">8.4.8. Step 7:  Build and run</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="resource_int_jacinto.html">8.5. FAQ - Used Resources - Interrupt</a></li>
<li class="toctree-l2"><a class="reference internal" href="faq_binlist_jacinto.html">8.6. FAQ - Supported Cores by example applications</a></li>
<li class="toctree-l2"><a class="reference internal" href="faq_module_clocking.html">8.7. FAQ - How to set the clock for a given module and clock</a></li>
<li class="toctree-l2"><a class="reference internal" href="apps_on_secure_devices.html">8.8. FAQ - Running Apps on secure devices</a></li>
<li class="toctree-l2"><a class="reference internal" href="faq_csi2rx.html">8.9. FAQ - CSI2RX</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../family_cfg/jacinto/index_developer_notes_jacinto.html">9. Developer Notes</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index_jacinto.html">Platform Development Kit (PDK) - JACINTO User Guide</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index_jacinto.html">Docs</a> &raquo;</li>
      
          <li><a href="../family_cfg/jacinto/index_faq_jacinto.html"><span class="section-number">8. </span>Frequently Asked Questions</a> &raquo;</li>
      
    <li><span class="section-number">8.4. </span>FAQ - C7x : Steps to switch C7x SysBIOS application from secure mode to non-secure mode</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="toctree-wrapper compound" id="c7x-non-secure-mode">
</div>
<section id="faq-c7x-steps-to-switch-c7x-sysbios-application-from-secure-mode-to-non-secure-mode">
<h1><span class="section-number">8.4. </span>FAQ - C7x : Steps to switch C7x SysBIOS application from secure mode to non-secure mode<a class="headerlink" href="#faq-c7x-steps-to-switch-c7x-sysbios-application-from-secure-mode-to-non-secure-mode" title="Permalink to this headline">¶</a></h1>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Starting SysBIOS v6.82.01.19 and later, C7x operating in purely secure mode will not be tested and C7x SysBIOS applications
have to migrate to use C7x in non-secure mode by following below steps.</p>
</aside>
<section id="introduction">
<h2><span class="section-number">8.4.1. </span>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>By default the C7x CPU boots in secure mode.
It is recommended to operate C7x in non-secure mode for below
reasons.</p>
<ul class="simple">
<li><p>While operating in secure mode, SW hosted on C7x, which is typically non-secure in nature, will be able to make secure
requests to DMSC. This is strongly discouraged unless really needed by SW since otherwise
it could open up a security hole in the overall system architecture.</p></li>
<li><p>ARM A72 SW and other SoCs and peripherals run in non-secure mode. For cache coherency between C7x cache and rest of SOC
to take effect, both the participating masters need to be at same privledge level. i.e C7x needs to be in non-secure mode
for cache coherency between C7x and A72, rest of SOC to take effect.</p></li>
</ul>
<p>C7x and SysBIOS when booted by boot loader runs in secure mode.
To operate C7x and SysBIOS in non-secure mode, during initialization of C7x,
the CPU mode has to be changed to non-secure mode by C7x SysBIOS init code.</p>
<p>From SysBIOS v6.82.01.19 and later, switching from secure to non-secure mode of operation is supported and
PDK/SDK is configued to use the same.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ul class="simple">
<li><p>ARM A72 and ARM R5F by default also boot in secure mode.</p></li>
<li><p>ARM A72 is switched from secure mode to non-secure mode before booting u-boot/liunx kernel by the ‘ARM Trusted Firmware’
or ATF which is the first SW that runs on A72</p></li>
<li><p>ARM R5F does not have any instruction to make it non-secure, instead at the boundary between R5F and SoC interconnect, there
is a HW called ‘ISC’. This HW can assert a non-secure attribute signal to make R5F transactions non-secure. Enabling assertion
of non-secure signal is initialized by DMSC FW when it is loaded during boot. Due to this all R5F’s in the SoC when booted run in
non-secure mode and R5F SW applications dont need any change.</p></li>
</ul>
</aside>
<p>This section describes how to modify an existing C7x SysBIOS user application to boot in secure mode
and then switch to non-secure mode during SysBIOS initialization.</p>
<p>${PDK_PATH} below refers to the place in SDK where PDK is located.</p>
</section>
<section id="step-1-sysbios-config-file-changes-to-enable-boot-to-non-secure">
<h2><span class="section-number">8.4.2. </span>Step 1: SysBIOS config file changes to enable boot to non-secure<a class="headerlink" href="#step-1-sysbios-config-file-changes-to-enable-boot-to-non-secure" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p>Add below lines to your C7x sysbios cfg file to enable switch for secure to non-secure during SysBIOS initialization</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span>var HwiC7x = xdc.useModule(&#39;ti.sysbios.family.c7x.Hwi&#39;);
HwiC7x.bootToNonSecure = true;
</pre></div>
</div>
</li>
<li><p>Make sure MMU init callback is set as shown below</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span>var Mmu = xdc.useModule(&#39;ti.sysbios.family.c7x.Mmu&#39;);
Mmu.initFunc = &quot;&amp;InitMmu&quot;;
Mmu.tableMemory = &quot;&quot;;
</pre></div>
</div>
</li>
<li><p>A example in PDK is shown in the below file</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">$</span><span class="p">{</span><span class="n">PDK_PATH</span><span class="p">}</span><span class="o">/</span><span class="n">packages</span><span class="o">/</span><span class="n">ti</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">j721e</span><span class="o">/</span><span class="n">sysbios_c7x</span><span class="p">.</span><span class="n">cfg</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="step-2-linker-command-file-changes">
<h2><span class="section-number">8.4.3. </span>Step 2: Linker command file changes<a class="headerlink" href="#step-2-linker-command-file-changes" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p>Add below line in your C7x linker command file to change the C7x application boot entry point to ‘_c_int00_secure’</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="o">-</span><span class="n">e</span><span class="w"> </span><span class="n">_c_int00_secure</span>
</pre></div>
</div>
</li>
<li><p>Add below to reserve space for MMU tables for secure and non-secure mode.
These sections can be placed anywhere in DDR (recommended)</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">MEMORY</span>
<span class="p">{</span>
<span class="w">    </span><span class="p">...</span>
<span class="w">    </span><span class="nl">C7X_DDR_SPACE</span><span class="p">:</span><span class="w"> </span><span class="n">org</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">C7X_DDR_SPACE_BASE</span><span class="p">,</span><span class="w">  </span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x00C00000</span>
<span class="p">}</span>

<span class="n">SECTIONS</span>
<span class="p">{</span>
<span class="w">    </span><span class="p">...</span>
<span class="w">    </span><span class="nl">GROUP</span><span class="p">:</span><span class="w">              </span><span class="o">&gt;</span><span class="w">  </span><span class="n">C7X_DDR_SPACE</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="cm">/* secure entry table */</span>
<span class="w">        </span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">ti_sysbios_family_c7x_Mmu_tableArray</span><span class="w">          </span><span class="o">:</span><span class="w"> </span><span class="n">type</span><span class="o">=</span><span class="n">NOINIT</span>
<span class="w">        </span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">ti_sysbios_family_c7x_Mmu_tableArraySlot</span><span class="w">      </span><span class="o">:</span><span class="w"> </span><span class="n">type</span><span class="o">=</span><span class="n">NOINIT</span>
<span class="w">        </span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">ti_sysbios_family_c7x_Mmu_level1Table</span><span class="w">         </span><span class="o">:</span><span class="w"> </span><span class="n">type</span><span class="o">=</span><span class="n">NOINIT</span>
<span class="w">        </span><span class="cm">/* non secure MMU table */</span>
<span class="w">        </span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">ti_sysbios_family_c7x_Mmu_tableArray_NS</span><span class="w">       </span><span class="o">:</span><span class="w"> </span><span class="n">type</span><span class="o">=</span><span class="n">NOINIT</span>
<span class="w">        </span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">ti_sysbios_family_c7x_Mmu_tableArraySlot_NS</span><span class="w">   </span><span class="o">:</span><span class="w"> </span><span class="n">type</span><span class="o">=</span><span class="n">NOINIT</span>
<span class="w">        </span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">ti_sysbios_family_c7x_Mmu_level1Table_NS</span><span class="w">      </span><span class="o">:</span><span class="w"> </span><span class="n">type</span><span class="o">=</span><span class="n">NOINIT</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p>Make sure the entry point ‘_c_int00_secure’ is 2MB aligned. And also place the ‘secure_vecs’ section in the
same linker command file as shown below</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">SECTIONS</span>
<span class="p">{</span>
<span class="w">    </span><span class="p">...</span>

<span class="w">    </span><span class="p">.</span><span class="n">secure_vecs</span><span class="w">    </span><span class="o">&gt;</span><span class="w">   </span><span class="n">C7X_DDR_SPACE</span><span class="w"> </span><span class="n">ALIGN</span><span class="p">(</span><span class="mh">0x200000</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="n">_c_int00_secure</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">C7X_DDR_SPACE</span><span class="w">  </span><span class="n">ALIGN</span><span class="p">(</span><span class="mh">0x200000</span><span class="p">)</span>

<span class="w">    </span><span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p>The symbol ‘_c_int00’ in the C7x application now represents the non-secure entry point.
The C7x when booted will jump to ‘_c_int00_secure’, and after some intialization it will then
jump to the non-secure entry point i.e ‘_c_int00’. Since ‘_c_int00’ is no longer the boot
entry point, this symbol need not be 2MB aligned and below line in your application can be now be
removed.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">SECTIONS</span>
<span class="p">{</span>
<span class="w">    </span><span class="p">...</span>

<span class="w">    </span><span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="n">_c_int00</span><span class="w"> </span><span class="o">&gt;</span><span class="w">    </span><span class="n">DDR_C7x_1_BOOT</span><span class="w">  </span><span class="n">ALIGN</span><span class="p">(</span><span class="mh">0x200000</span><span class="p">)</span>

<span class="w">    </span><span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p>Since ‘_c_int00’ is no longer the boot entry point for C7x, the C7x linker will complain with a warning.
This specfic warning can be safely supressed by adding below to your linker options:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#</span>
<span class="cp"># Suppress this warning, 10063-D: entry-point symbol other than &quot;_c_int00&quot; specified</span>
<span class="cp"># c7x boots in secure mode and to switch to non-secure mode we need to start at a special entry point &#39;_c_int00_secure&#39;</span>
<span class="cp"># and later after switching to non-secure mode, sysbios jumps to usual entry point of _c_int00</span>
<span class="cp"># Hence we need to suppress this warning</span>
<span class="n">LNKFLAGS_INTERNAL_COMMON</span><span class="o">+=--</span><span class="n">diag_suppress</span><span class="o">=</span><span class="mi">10063</span>
</pre></div>
</div>
</li>
<li><p>A example in PDK, which does all of above changes, is shown in below files:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">$</span><span class="p">{</span><span class="n">PDK_PATH</span><span class="p">}</span><span class="o">/</span><span class="n">packages</span><span class="o">/</span><span class="n">ti</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">j721e</span><span class="o">/</span><span class="n">linker_c7x</span><span class="p">.</span><span class="n">lds</span>
<span class="n">$</span><span class="p">{</span><span class="n">PDK_PATH</span><span class="p">}</span><span class="o">/</span><span class="n">packages</span><span class="o">/</span><span class="n">ti</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">makerules</span><span class="o">/</span><span class="n">rules_71</span><span class="p">.</span><span class="n">mk</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="step-3-mmu-initialization-to-setup-secure-and-non-secure-mmu-tables">
<h2><span class="section-number">8.4.4. </span>Step 3: MMU initialization to setup secure and non-secure MMU tables<a class="headerlink" href="#step-3-mmu-initialization-to-setup-secure-and-non-secure-mmu-tables" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p>C7x has a MMU which is needed to effectively operate C7x including for cache of C7x to take effect</p></li>
<li><p>C7x has separate MMU table for secure and non-secure mode. User needs to setup both secure as well
as non-secure mode MMU table for correct operation.</p></li>
<li><p>For simplicity we set the same MMU entries for both secure and non-secure mode MMU tables.</p>
<ul>
<li><p>The OsalInitMmu() function takes a parameter ‘isSecure’ to tell if we are configuring the secure mode MMU table
or non-secure mode MMU table.</p></li>
<li><p>This OsalInitMmu() is called twice in Osal_initMmuDefault() once with the parameter as TRUE for secure and
once with parameter as FALSE for non-secure</p></li>
<li><p>CLEC and Cache init is also done in the MMU callback function, see next steps for details.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;ti/sysbios/family/c7x/Mmu.h&gt;</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">OsalInitMmu</span><span class="p">(</span><span class="n">Bool</span><span class="w"> </span><span class="n">isSecure</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">Mmu_MapAttrs</span><span class="w">    </span><span class="n">attrs</span><span class="p">;</span>

<span class="w">    </span><span class="n">Mmu_initMapAttrs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attrs</span><span class="p">);</span>
<span class="w">    </span><span class="n">attrs</span><span class="p">.</span><span class="n">attrIndx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Mmu_AttrIndx_MAIR0</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">TRUE</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">isSecure</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">attrs</span><span class="p">.</span><span class="n">ns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="cm">/* set ns bit for this MMU entry to 0, i.e this is secure MMU entry */</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">attrs</span><span class="p">.</span><span class="n">ns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="cm">/* set ns bit for this MMU entry to 1, i.e this is non-secure MMU entry */</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/* when &#39;isSecure&#39; is 1, Mmu_map() write to secure MMU table, else it writes to non-secure MMU table */</span>
<span class="w">    </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">Mmu_map</span><span class="p">(</span><span class="mh">0x00000000U</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00000000U</span><span class="p">,</span><span class="w"> </span><span class="mh">0x20000000U</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">attrs</span><span class="p">,</span><span class="w"> </span><span class="n">isSecure</span><span class="p">);</span>

<span class="w">    </span><span class="p">...</span><span class="w"> </span><span class="cm">/* other Mmu_map calls */</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">Osal_initMmuDefault</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="cm">/* setup MMU for non-secure */</span>
<span class="w">    </span><span class="n">OsalInitMmu</span><span class="p">(</span><span class="n">FALSE</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* setup MMU for secure */</span>
<span class="w">    </span><span class="n">OsalInitMmu</span><span class="p">(</span><span class="n">TRUE</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* Setup CLEC access/configure in non-secure mode */</span>
<span class="w">    </span><span class="n">OsalCfgClecAccessCtrl</span><span class="p">(</span><span class="n">FALSE</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* Setup L1/L2 cache size */</span>
<span class="w">    </span><span class="n">OsalCfgCache</span><span class="p">();</span>

<span class="w">    </span><span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* MMU init callback function, called by SysBIOS in</span>
<span class="cm">  secure mode during init before switching to non-secure mode */</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">InitMmu</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">Osal_initMmuDefault</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>A example in PDK, which does all of above changes, is shown in below file:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">$</span><span class="p">{</span><span class="n">PDK_PATH</span><span class="p">}</span><span class="o">/</span><span class="n">packages</span><span class="o">/</span><span class="n">ti</span><span class="o">/</span><span class="n">osal</span><span class="o">/</span><span class="n">soc</span><span class="o">/</span><span class="n">j721e</span><span class="o">/</span><span class="n">bios_mmu</span><span class="p">.</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">OsalInitMmu</span><span class="p">(),</span><span class="w"> </span><span class="n">Osal_initMmuDefault</span><span class="p">()</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="step-4-clec-initialization-to-allow-non-secure-mode-access">
<h2><span class="section-number">8.4.5. </span>Step 4: CLEC initialization to allow non-secure mode access<a class="headerlink" href="#step-4-clec-initialization-to-allow-non-secure-mode-access" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p>CLEC is used by user applications to route system interrupts to C7x interrupt controller.
By default CLEC registers can be written only in secure mode.</p></li>
<li><p>Since SysBIOS is configured to operate in non-secure mode, if user application tries to access CLEC
it will result in a exception.</p></li>
<li><p>To avoid this exception, we will have to initialize CLEC to allow it to be accessible in non-secure mode as well.
This CLEC initialzation however needs to be done before the C7x switches from secure to non-secure mode.
Due to this, we do the CLEC init in the MMU init callback function as shown below. At this point C7x is still
in secure mode.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;ti/csl/soc.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;ti/csl/csl_clec.h&gt;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">OsalCfgClecAccessCtrl</span><span class="w"> </span><span class="p">(</span><span class="n">Bool</span><span class="w"> </span><span class="n">onlyInSecure</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">CSL_ClecEventConfig</span><span class="w"> </span><span class="n">cfgClec</span><span class="p">;</span>
<span class="w">    </span><span class="n">CSL_CLEC_EVTRegs</span><span class="w">   </span><span class="o">*</span><span class="n">clecBaseAddr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">CSL_CLEC_EVTRegs</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">CSL_COMPUTE_CLUSTER0_CLEC_REGS_BASE</span><span class="p">;</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w">            </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">maxInputs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2048U</span><span class="p">;</span>

<span class="w">    </span><span class="n">cfgClec</span><span class="p">.</span><span class="n">secureClaimEnable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">onlyInSecure</span><span class="p">;</span>
<span class="w">    </span><span class="n">cfgClec</span><span class="p">.</span><span class="n">evtSendEnable</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">FALSE</span><span class="p">;</span>
<span class="w">    </span><span class="n">cfgClec</span><span class="p">.</span><span class="n">rtMap</span><span class="w">             </span><span class="o">=</span><span class="w"> </span><span class="n">CSL_CLEC_RTMAP_DISABLE</span><span class="p">;</span>
<span class="w">    </span><span class="n">cfgClec</span><span class="p">.</span><span class="n">extEvtNum</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="mi">0U</span><span class="p">;</span>
<span class="w">    </span><span class="n">cfgClec</span><span class="p">.</span><span class="n">c7xEvtNum</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="mi">0U</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0U</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">maxInputs</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">CSL_clecConfigEvent</span><span class="p">(</span><span class="n">clecBaseAddr</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cfgClec</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">Osal_initMmuDefault</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="cm">/* setup MMU for non-secure */</span>
<span class="w">    </span><span class="n">OsalInitMmu</span><span class="p">(</span><span class="n">FALSE</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* setup MMU for secure */</span>
<span class="w">    </span><span class="n">OsalInitMmu</span><span class="p">(</span><span class="n">TRUE</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* Setup CLEC access/configure in non-secure mode */</span>
<span class="w">    </span><span class="n">OsalCfgClecAccessCtrl</span><span class="p">(</span><span class="n">FALSE</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* Setup L1/L2 cache size */</span>
<span class="w">    </span><span class="n">OsalCfgCache</span><span class="p">();</span>

<span class="w">    </span><span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* MMU init callback function, called by SysBIOS in</span>
<span class="cm">  secure mode during init before switching to non-secure mode */</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">InitMmu</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">Osal_initMmuDefault</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p>A example in PDK, which does all of above changes, is shown in below file:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">$</span><span class="p">{</span><span class="n">PDK_PATH</span><span class="p">}</span><span class="o">/</span><span class="n">packages</span><span class="o">/</span><span class="n">ti</span><span class="o">/</span><span class="n">osal</span><span class="o">/</span><span class="n">soc</span><span class="o">/</span><span class="n">j721e</span><span class="o">/</span><span class="n">bios_mmu</span><span class="p">.</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">OsalCfgClecAccessCtrl</span><span class="p">()</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="step-5-cache-initialization-to-partition-l1-l2-as-cache-vs-ram">
<h2><span class="section-number">8.4.6. </span>Step 5: Cache initialization to partition L1/L2 as cache vs RAM<a class="headerlink" href="#step-5-cache-initialization-to-partition-l1-l2-as-cache-vs-ram" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p>By default, C7x boots with 32K L1 P/D cache and 0 bytes L2 cache. To change this one needs to
use the BIOS API, ‘Cache_setSize’.</p></li>
<li><p>However this API needs to be called when when C7x is in secure mode.</p></li>
<li><p>This API has no effect when C7x is non-secure mode. Further this API must be called
after the MMU table entries are setup.</p></li>
<li><p>Hence we call this API in the MMU init callback function, AFTER the MMU entries are setup.</p></li>
<li><p>Below is sample code to setup cache of L1P, L1D as 32KB and L2 as 64KB</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;ti/sysbios/family/c7x/Cache.h&gt;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">OsalCfgCache</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">ti_sysbios_family_c7x_Cache_Size</span><span class="w">  </span><span class="n">cacheSize</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* init cache size here, since this needs to be done in secure mode */</span>
<span class="w">    </span><span class="n">cacheSize</span><span class="p">.</span><span class="n">l1pSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ti_sysbios_family_c7x_Cache_L1Size_32K</span><span class="p">;</span>
<span class="w">    </span><span class="n">cacheSize</span><span class="p">.</span><span class="n">l1dSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ti_sysbios_family_c7x_Cache_L1Size_32K</span><span class="p">;</span>
<span class="w">    </span><span class="n">cacheSize</span><span class="p">.</span><span class="n">l2Size</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">ti_sysbios_family_c7x_Cache_L2Size_64K</span><span class="p">;</span>
<span class="w">    </span><span class="n">Cache_setSize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cacheSize</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">Osal_initMmuDefault</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="cm">/* setup MMU for non-secure */</span>
<span class="w">    </span><span class="n">OsalInitMmu</span><span class="p">(</span><span class="n">FALSE</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* setup MMU for secure */</span>
<span class="w">    </span><span class="n">OsalInitMmu</span><span class="p">(</span><span class="n">TRUE</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* Setup CLEC access/configure in non-secure mode */</span>
<span class="w">    </span><span class="n">OsalCfgClecAccessCtrl</span><span class="p">(</span><span class="n">FALSE</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* Setup L1/L2 cache size */</span>
<span class="w">    </span><span class="n">OsalCfgCache</span><span class="p">();</span>

<span class="w">    </span><span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* MMU init callback function, called by SysBIOS in</span>
<span class="cm">  secure mode during init before switching to non-secure mode */</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">InitMmu</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">Osal_initMmuDefault</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="step-6-sciclient-init-to-use-non-secure-mode">
<h2><span class="section-number">8.4.7. </span>Step 6: Sciclient init to use non-secure mode<a class="headerlink" href="#step-6-sciclient-init-to-use-non-secure-mode" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p>Now C7x is in non-secure node after initilization is done.</p></li>
<li><p>We need to now tell SCICLIENT that C7x is in non-secure mode.</p></li>
<li><p>This is specified by setting ‘isSecureMode’ flag as ‘0’ during SCICLIENT init as shown below</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Sciclient_configPrmsInit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sciClientCfg</span><span class="p">);</span>
<span class="n">sciClientCfg</span><span class="p">.</span><span class="n">isSecureMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0U</span><span class="p">;</span>
<span class="n">retVal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sciclient_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sciClientCfg</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p>In PDK, this change is done in below file. Note, here ‘sciClientCfg.isSecureMode = 0’ is not explicitly done, since
‘Sciclient_configPrmsInit’, makes this flag as ‘0’ by default</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">$</span><span class="p">{</span><span class="n">PDK_PATH</span><span class="p">}</span><span class="o">/</span><span class="n">packages</span><span class="o">/</span><span class="n">ti</span><span class="o">/</span><span class="n">board</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">j721e_evm</span><span class="o">/</span><span class="n">board_init</span><span class="p">.</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">Board_sysInit</span><span class="p">()</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="step-7-build-and-run">
<h2><span class="section-number">8.4.8. </span>Step 7:  Build and run<a class="headerlink" href="#step-7-build-and-run" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Build, load/boot and run your C7x application as usual after doing above changes</p></li>
<li><p>When your application comes to main(), C7x has been already switched from secure to non-secure mode by the BIOS inialization code.</p></li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="resource_int_jacinto.html" class="btn btn-neutral float-right" title="8.5. FAQ - Used Resources - Interrupt" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="faq_fvid2.html" class="btn btn-neutral" title="8.3. FAQ - FVID2" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
      <a href="http://www.ti.com/corp/docs/legal/copyright.shtml">&copy; Copyright 1995-2020</a>, Texas Instruments Incorporated. All rights reserved. <br>
      <a href="http://www.ti.com/corp/docs/legal/trademark/trademrk.htm">Trademarks</a> | <a href="http://www.ti.com/corp/docs/legal/privacy.shtml">Privacy policy</a> | <a href="http://www.ti.com/corp/docs/legal/termsofuse.shtml">Terms of use</a> | <a href="http://www.ti.com/lsds/ti/legal/termsofsale.page">Terms of sale</a>

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'09_00_01',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

    <script src="http://www.ti.com/assets/js/headerfooter/analytics.js" type="text/javascript" charset="utf-8"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
        });

      var menuHeight = window.innerHeight;

      var contentOffset = $(".wy-nav-content-wrap").offset();
      var contentHeight = $(".wy-nav-content-wrap").height();
      var contentBottom = contentOffset.top + contentHeight;

      function setNavbarTop() {
          var scrollTop = $(window).scrollTop();
          var maxTop = scrollTop + menuHeight;

          // If past the header
          if (scrollTop > contentOffset.top && maxTop < contentBottom) {
            stickyTop = scrollTop - contentOffset.top;
          } else if (maxTop > contentBottom) {
            stickyTop = scrollTop - contentOffset.top - (maxTop - contentBottom);
          } else {
            stickyTop = 0;
          }

          $(".wy-nav-side").css("top", stickyTop);
      }

      $(document).ready(function() {
        setNavbarTop();
        $(window).scroll(function () {
          setNavbarTop();
        });
      });
  </script>
   

</body>
</html>